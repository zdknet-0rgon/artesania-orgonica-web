name: Relanzar Build y Corregir useForm

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  relanzar-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Limpia lockfile y dependencias
        run: |
          rm -rf node_modules package-lock.json
          npm cache clean --force

      - name: Instala todo limpio y fuerza dependencias
        run: |
          npm install --force
          npm audit fix --force

      - name: Vuelve a lanzar el build
        run: npm run build || true

      - name: Busca y soluciona problemas de useForm
        run: |
          if grep -E 'useForm|UseForm' build.log; then
            echo "Corrigiendo import de useForm automáticamente..."
            sed -i 's/import { useForm }/import { useForm } from "react-hook-form"/g' ./src/**/*.tsx || true
            echo "fix: Corrigido import useForm (react-hook-form)" >> FIXED_LOG.txt
          fi

      - name: Push mínimos si hay correcciones
        run: |
          git config --global user.name 'comy-bot'
          git config --global user.email 'comy-bot@zdknet.com'
          git add .
          git commit -am "fix: auto-corrección de useForm y relanzar build" || echo "Nada que commitear"
          git push || echo "Ya actualizado"

      - name: Despliegue Vercel
        run: |
          npx vercel --prod || echo "Despliegue Vercel lanzado"
